@model QRCodeEvidentationApp.Models.DTO.PaginatedLecturesViewModel

@{
    ViewData["Title"] = "Lectures";
}

<h1 class="text-center my-4">@ViewData["Title"]</h1>

<p class="text-end">
    <a asp-action="CreateView" class="btn btn-success">Create New Lecture</a>
    <a asp-action="BulkAddLecturesView" class="btn btn-info text-white">Bulk add</a>
</p>

<div class="table-responsive">
    <table id="lecturesTable" class="table table-bordered table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>@Html.DisplayNameFor(model => model.Lectures[0].Title)</th>
                <th>@Html.DisplayNameFor(model => model.Lectures[0].StartsAt)</th>
                <th>@Html.DisplayNameFor(model => model.Lectures[0].Type)</th>
                <th>@Html.DisplayNameFor(model => model.Lectures[0].ValidRegistrationUntil)</th>
                @* <th>@Html.DisplayNameFor(model => model.Lectures[0].RoomName)</th> *@
                <th class="text-center">Actions</th>
            </tr>
        </thead>
    <tbody id="lecturesTableBody">
        @foreach (var item in Model.Lectures)
        {
            <tr id="lecture-row-@item.Id">
                <td>@Html.DisplayFor(modelItem => item.Title)</td>
                <td>    @(item.StartsAt.ToString("dd-MM-yyyy HH:mm:ss"))</td>
                <td>@Html.DisplayFor(modelItem => item.Type)</td>
                <td id="#validRegistrationUntil">
                    @(item.ValidRegistrationUntil?.ToString("dd-MM-yyyy HH:mm:ss") ?? "N/A")
                </td>
                @* <td>@Html.DisplayFor(modelItem => item.RoomName)</td> *@
                <td class="text-center">
                    <div class="btn-group" role="group">
                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-primary m-1">Edit</a>
                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-primary m-1">Details</a>
                        <button class="btn btn-sm btn-warning m-1 disable-lecture-btn" data-lecture-id="@item.Id" data-valid-registration-until="@item.ValidRegistrationUntil">Disable Lecture</button>
                        <a asp-action="GetLectureAnalytics" asp-route-id="@item.Id" class="btn btn-sm btn-primary m-1">Analytics</a>
                    </div>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<!-- Pagination controls -->
<div class="text-center">
    <nav aria-label="Page navigation">
        <ul class="pagination" id="paginationControls">
            @for (var i = 1; i <= Model.TotalPages; i++)
            {
            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                <a class="page-link" href="javascript:void(0);" data-page="@i">@i</a>
            </li>
            }
        </ul>
    </nav>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.13.5/sorting/datetime-moment.js"></script>

    <script>
        $(document).ready(function () {
            $.fn.dataTable.moment('DD-MM-YYYY HH:mm:ss');

            function initializeDisableButtons() {
                $('.disable-lecture-btn').each(function () {
                    var validRegistrationUntil = new Date($(this).data('valid-registration-until'));
                    var now = new Date();
                    if (now > validRegistrationUntil) {
                        $(this).prop('disabled', true);
                    }
                });
            }

            // Initialize DataTable
            $('#lecturesTable').DataTable({
                paging: false,         // Enable pagination
                searching: true,       // Enable searching
                ordering: true,        // Enable column ordering
                lengthChange: true,    // Allow changing page length
                autoWidth: false,      // Disable auto width for better responsiveness
                responsive: true,      // Enable responsive table
                order: [],
                columnDefs: [
                    { targets: [0], searchable: true },
                    { targets: [1, 3], type: 'datetime-moment' }, // Use the correct type
                    { targets: '_all', searchable: false }
                ]
            });

            initializeDisableButtons();

            $(document).on('click', '.page-link', function () {
                var page = $(this).data('page');
                loadLectures(page);
            });

            function loadLectures(page) {
                $.ajax({
                    url: '@Url.Action("Index")',
                    type: 'GET',
                    data: { page: page },
                    success: function (data) {
                        // Destroy the previous DataTable instance
                        if ($.fn.dataTable.isDataTable('#lecturesTable')) {
                            $('#lecturesTable').DataTable().clear().destroy();
                            $.fn.dataTable.moment('DD-MM-YYYY HH:mm:ss');
                        }

                        // Update the table body and pagination controls
                        $('#lecturesTableBody').html($(data).find('#lecturesTableBody').html());
                        $('#paginationControls').html($(data).find('#paginationControls').html());

                        // Reinitialize the DataTable
                        $('#lecturesTable').DataTable({
                            paging: false,
                            searching: true,
                            ordering: true,
                            lengthChange: true,
                            autoWidth: false,
                            responsive: true,
                            order: [],
                            columnDefs: [
                                { targets: [0], searchable: true },
                                { targets: [1, 3], type: 'datetime-moment' }, // Use the correct type
                                { targets: '_all', searchable: false }
                            ]
                        });

                        // Reinitialize the disable button logic
                        initializeDisableButtons();
                    },
                    error: function (xhr, status, error) {
                        alert('Error loading lectures');
                    }
                });
            }

            $('.disable-lecture-btn').each(function () {
                var validRegistrationUntil = new Date($(this).data('valid-registration-until'));
                var now = new Date();
                if (now > validRegistrationUntil) {
                    $(this).prop('disabled', true);
                }
            });

            function formatDate(date) {
                var options = {
                    month: 'numeric', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: 'numeric', second: 'numeric',
                    hour12: true
                };
                return new Intl.DateTimeFormat('en-US', options).format(date);
            }

            $(document).on('click', '.disable-lecture-btn', function (e) {
                e.preventDefault();
                var button = $(this);
                var lectureId = button.data('lecture-id');
                $.ajax({
                    url: '@Url.Action("DisableLecture")',
                    type: 'POST',
                    data: {
                        id: lectureId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (result) {
                        if (result.success) {
                            alert(result.message);
                            button.prop('disabled', true);
                            var formattedDate = formatDate(new Date(result.validRegistrationUntil));
                            $('#lecture-row-' + lectureId).find('td').eq(3).text(formattedDate);
                        } else {
                            alert('Error: ' + result.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Error disabling lecture');
                    }
                });
            });
        });
    </script>
}